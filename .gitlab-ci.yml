# Based on this template:
# https://gitlab.com/gitlab-org/gitlab/-/blob/master/lib/gitlab/ci/templates/Go.gitlab-ci.yml

image: golang:latest

variables:
  # https://docs.gitlab.com/ee/user/packages/container_registry/build_and_push_images.html#container-registry-examples-with-gitlab-cicd
  # https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#docker-in-docker-with-tls-enabled-in-the-docker-executor
  DOCKER_TLS_CERT_DIR: "/certs"
  # SonarQube
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

# https://docs.gitlab.com/ci/yaml/yaml_optimization/#yaml-anchors-for-scripts
.go-setup: &go-setup
  # Fix "cmd/fmdserver.go:19:2: no required module provides package gopkg.in/yaml.v3; to add it:" (only an issue in CI...)
  - go get gopkg.in/yaml.v3

stages:
  - lint
  - test
  - build

# pnpm cache configuration
.pnpm-cache: &pnpm-cache
  cache:
    key:
      files:
        - web/pnpm-lock.yaml
    paths:
      - .pnpm-store

format:
  stage: lint
  needs:
    - job: web:build
      artifacts: true
  script:
    - *go-setup
    - go mod tidy
    - go fmt $(go list ./... | grep -v /vendor/)
    - go vet $(go list ./... | grep -v /vendor/)

# https://staticcheck.dev/
staticcheck:
  stage: lint
  needs:
    - job: web:build
      artifacts: true
  script:
    - *go-setup
    - go install honnef.co/go/tools/cmd/staticcheck@latest
    - staticcheck $(go list ./...)

nil-safety:
  stage: lint
  needs:
    - job: web:build
      artifacts: true
  script:
    - *go-setup
    - go install go.uber.org/nilaway/cmd/nilaway@latest
    - nilaway -include-pkgs="fmd-server" ./...

sonarcloud-check:
  stage: lint
  image:
    name: sonarsource/sonar-scanner-cli:latest
    entrypoint: [""]
  cache:
    key: "${CI_JOB_NAME}"
    paths:
      - .sonar/cache
  script:
    - sonar-scanner
  rules:
    - if: $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: true # This step fails in forks due to the missing API key.

web:format:
  stage: lint
  image: node:24-alpine
  <<: *pnpm-cache
  before_script:
    - cd web
    - corepack enable
    - pnpm config set store-dir ../.pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm format:check
  only:
    changes:
      - web/**/*

web:typecheck:
  stage: lint
  image: node:24-alpine
  <<: *pnpm-cache
  before_script:
    - cd web
    - corepack enable
    - pnpm config set store-dir ../.pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm type-check
  only:
    changes:
      - web/**/*

web:build:
  stage: lint
  image: node:24-alpine
  <<: *pnpm-cache
  before_script:
    - cd web
    - corepack enable
    - pnpm config set store-dir ../.pnpm-store
    - pnpm install --frozen-lockfile
  script:
    - pnpm build
  artifacts:
    paths:
      - web/dist/
    expire_in: 1 week

unit-test:
  stage: test
  script:
    - *go-setup
    - go test -race $(go list ./... | grep -v /vendor/)\

compile:
  stage: build
  needs:
    - job: web:build
      artifacts: true
  script:
    - *go-setup
    - go build -o fmdserver
  artifacts:
    paths:
      - fmdserver

docker-build:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  script:
    - |
      if [[ "$CI_COMMIT_TAG" != "" ]]; then
        ./docker/build_images.sh "$CI_COMMIT_TAG"
      else
        echo "No git tag! Not building image."
      fi
  retry: 2
  rules:
      # Only run this job on tagging a release. This is to save pipeline minutes.
      # This step takes 10 to 40 mins, thus quickly eating up pipeline minutes.
    - if: $CI_COMMIT_TAG =~ /^v?[0-9\.]+$/

docker-rebuild:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  script:
    - ./docker/rebuild_images.sh
  retry: 2
  rules:
    # Run this job as a scheduled pipeline.
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Run this job when triggered manually via the GitLab UI.
    - when: manual
